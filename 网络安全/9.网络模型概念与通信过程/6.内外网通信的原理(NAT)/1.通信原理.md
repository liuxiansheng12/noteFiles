
#### NAT的概念与作用
- 互联网上的路由器，是不会转发目标IP为内网IP的数据包的
- 运营商扯的那根网线，插到划分内网和外网路由器上，插的那个端口（WAN）对应的IP就是公网IP
  - 所有往这个路由器下的内网发送的数据包
    - **目标IP就会把内网IP更换成这个公网IP（对方路由器替换），然后才会在互联网中进行传输**
    - **这个内网下的所有往互联网发送的数据包，也会把源IP更换成这个公网IP，用于回包**
      - 虽然不进行替换，也能发送，但是回包是接收不了的，
  - 然后连接公网的路由器，会根据内部的配置，再把公网IP替换成真实的内网IP，然后再进行路由，送到内网机器上

#### 内网范围
- 10.0.0.0/8 （10开头的）
- 172.16.0.0/16 - 172.31.0.0/16 （172.16开头的一直到172.31开头的）
- 192.168.0.0/16 （192.168开头的）

#### NAT分类
- 静态NAT（弃用，但是可以配置静态PAT，内网提供服务）
  - 内网提供服务，服务器搭建在内网中，可以向外网提供服务
- 动态NAT（弃用）
- PAT（端口地址转换，端口映射）


#### 静态NAT
- 直接写死，只能为一台内网设备提供服务，太局限性，所以弃用
  - 只能一台设备可以发包和收包，其他的只能发送数据包，无法收到回包
  - 即：只能一台设备上网（具体原因看下面介绍）
- 网络示意图
<img src="https://lsz.net.cn/node/imgs/15f6a13af6845f1c8431b9bdeef03719.png" />

- 上网流程分析（往外发送数据包）
  - 由于NAT地址转换表中只存在，192.168.62.1的映射
  - 所以当这三个内网设备的数据包，到达这个外网端口的时候，只有源IP是192.168.62.1的数据包，会把源IP替换成 10.3.4.5，其他的不动
  - 数据包会经过路由，顺利发送到 10.3.6.5
  - 10.3.6.5 回包的时候（根据源IP，作为目标IP进行回包）
    - 由于 192.168.62.1 已经替换 10.3.4.5（公网IP）
      - 所以回包的时候，就会把包回给10.3.4.5
      - 路由器会根据NAT映射，把10.3.4.5在替换成 192.168.62.1 
      - 然后在进行路由，就会把包顺利的回到192.168.62.1，实现上网
    - 回另外两台设备的时候，由于源IP还是内网IP，所以回包的目标IP就是内网IP，但是公网中不能存在内网IP，所以数据包就会被干掉
      - 也就是 2 和 3 无法收到回包，无法进行上网

- NAT地址转换表中可以存在多个
  - 比如：在加一条 s   192.168.62.2    10.3.4.5
  - 但是接收到回包，路由器就区分不了这个包是发送给 1 还是 2 的了
    - 两个源IP都会替换成  10.3.4.5 
    - 也就是回包的时候，两个包的目标IP都是  10.3.4.5
    - 两个目标IP都一样，这样，路由器就无法进行区分了
  - 除非多买几个公网IP

#### 动态NAT
- 动态生成NAT，但是同一时间也只能为一台内网设备提供服务，太局限性，所以弃用
  - 只能一台设备可以发包和收包，其他的只能发送数据包，无法收到回包
  - 即：同时只能一台设备上网
    - 谁先上网谁就可以上网，后续的人无法上网
    - 除非这个人不上网了，过段时间（公网IP释放了），就又有一个人可以上网了
    - 具体原因看下面介绍
- 网络示意图
<img src="https://lsz.net.cn/node/imgs/08cbe2aa138182b53b745bd3feb4ed44.png" />

- 动态NAT地址转换表的生成过程
  - 当 1、2、3上网的时候（往公网上发送数据包）
  - 会先去内部地址池，进行比较，如果符合（这这个网段下的IP）
    - 就会从外部地址池中取出一个公网IP（取出后就会消失）
    - 然后就会把源IP替换成取出的公网IP，发送出去，并且产生一个NAT地址映射
    - 如果外部地址池中没有公网IP了，则不进行替换源IP地址，直接往外发送
  - 这样，谁先上网，谁就能上网，后面的人就无法上网了
    - 外部地址池中的公网IP已经被第一个人占用了（空了）
    - 除非，地址池中有多个公网IP
  - 比如 192.168.62.1 先上网
    - NAT地址转换中，就会形成一条记录 s   192.168.62.1   10.3.4.5
    - 这样在回包的时候，NAT地址转换记录已经产生了，所以就会把目标IP 10.3.4.5 更换成 192.168.62.1
    - 这样，192.168.62.1 能收到回包
      - 意味着，后面只能192.168.62.1进行上网了
      - 2和3无法收到回包，也就无法上网

- 通信原理与静态NAT一样，问题也一样（只能服务一台设备，除非多买几个公网IP）

#### PAT
- 动态生成NAT，但是由于利用了端口映射，也就是一个端口就可以映射一台设备
  - 而一台设备（路由器）中存在65535个端口，每个端口映射一台设备
  - 也就意味着可以65535个内网设备进行同时上网，再多就不行了

- 网络示意图
<img src="https://lsz.net.cn/node/imgs/08cbe2aa138182b53b745bd3feb4ed44.png" />

- NAT地址转换表中的内容也是动态生成的，原理和上面的一样，但是生成的内容不同（含有映射端口）
  - 动态产生的NAT地址转换：s  192.168.62.1  10.3.4.5 423 1
    - 表示：源IP为192.168.62.1，并且源端口是 423 的数据包，最终会被替换成源IP为10.3.4.5，源端口为1的数据包
    - 这样在回包的时候，目标IP就是10.3.4.5，目标端口为1
    - 当路由器接收到数据包，与NAT地址转换表中的映射进行比较，然后进行替换（目标IP替换成192.168.62.1，目标端口替换成423，实现上网）
  - 当其他设备上网的时候，又会产生一条NAT地址转换
    - 比如：s  192.168.62.2  10.3.4.5 92 2
    - 这样，路由器的2端口接收到回包，就会把目标IP替换成192.168.62.2，目标端口替换成92，这台设备也能上网了
  - 这样，就可以根据端口的不同，来区分回包映射那台设备，从而使对应的回包发送到对应的内网设备上，使其多台设备可以同时上网
  - 同一设备的多个端口同时上网，也会形成不同的端口映射
    - 比如 
      - s  192.168.62.1  10.3.4.5 423 1
      - s  192.168.62.1  10.3.4.5 424 3
    - 这样
      - 路由器1端口接收到数据，就会把目标IP替换成192.168.62.1，目标端口替换成423
      - 路由器3端口接收到数据，就会把目标IP替换成192.168.62.1，目标端口替换成424
    - 使其对应端口发送的数据包的回包，可以正确的发送到目标端口上
  - PAT构建端口映射的时候，会自动查询那个端口没有被占用，从而构建映射
    - 也就是，不会一个端口映射出两条结果
    

#### 静态NAT和动态NAT弃用的原因，PAT替代他们的原因
- 静态NAT和动态NAT，没有利用到端口，直接用IP进行映射，但是**IP就一个，只能产生一个映射，所以同时只能有一台设备进行上网**
  - 因为多了无法进行映射
    - 比如：1映射这个IP，2也映射这个IP
    - 当他们上网的时候（往互联网发送数据包），路由器更换源IP（换成映射的IP），由于两个映射的是同一个IP，所以最终源IP就会变成一样的
    - 这样在回包的时候，这个路由器接受到数据包，就无法区分这个数据包该发给内网下的那台设备（1还是2）
  - 可以购买多个公网IP，这样就可以映射多个（也是一个IP映射一台设备）
- 而PAT利用了端口做映射，这样一个公网IP就可以映射出多台设备
  - 比如：1映射24端口，2映射36端口
  - 这样，路由器就会替换1和2，发往互联网的数据包中的源IP和源端口
    - 会把源IP替换公网IP
    - 同时把端口替换成1和2对应的映射端口（静态NAT和动态NAT不会替换，是什么发出去的就是什么）
      - 1映射24端口，2映射36端口
  - 这样回包的时候，1的回包就会回到24端口，2的回包就会回到36端口
    - 这样，路由器就可以区分这两个回包分别属于谁，就会把目标IP和目标端口，替换成1和2发包时使用的源IP和源端口
    - 这样，路由器就会把1和2的回包路由到对应的设备上，对应的端口上，实现上网