#### 配置流程
- VPN加密传输数据分为两步：管理连接、数据连接

- 其中管理连接，根本目的得到对称加密的密钥，数据连接用得到的加密密钥，选择一个加密方式，进行数据的加密传输
  - 只有第二步才和要传输的数据挂钩


#### 管理连接的配置
- 该配置，一个路由器上可以只配置一份，也可以配置多份
- 无论配置多少份，在和某个路由器开启点对点VPN的时候，**会挨个把配置发送过去，和对方进行比较，有一个相同才能建立VPN通道**
  - 对方接到一个配置后，就会和自己的所有配置进行比较，只要有一个符合，就表示VPN可以建立（于是就会根据双方相同的配置，开始协商密钥）
  - 如果这个和接受方的配置都不符合，则发送第二个配置
  - 如果所有的配置都不符合，则VPN建立失败
    - 无法确定加密算法啥的，也就无法得到相同的对称密钥，所以无法建立VPN

|
- 具体命令
```conf
conf t
crypto isakmp policy 1      # 1是配置编号（如果想要多配置几个，其他的编号可以是2、3、4）
  encryption des/3des/aes   # 选一个对称加密的算法
  hash md5/sha              # 选一个hash算法，验证数据完整性
  group 1/2/5               # 选一个DH的版本，版本越高，DH算法生成的数据越长，就越安全，通常选2
  authentication pre-share  # 数据验证的时候，利用到配置的预共享密钥
  lifetime 秒               # 更新时间，默认1天，更新时间一到，双方重新协商对称加密的密钥
                            #    可以防止之前的被泄漏（定时更新）
  exit
```
- 建立VPN的时候，就会把上面配置的 1 发给对方（如果有多个，比如 2、3、4，会挨个发送，有一个相同就行，然后就会启用相同配置中选定的加密算法，协商出对称加密密钥）


#### 数据连接的配置
- 1、定义传输过程中的加密方式（管理连接连接定义的加密方式和他没有关系）
  - **选择的加密方式，VPN双方要一样**
  - 加密方式定义好后，**就会用管理连接得到的对称密钥，进行数据的加密传输**
  - 具体命令
    ```conf
    conf t
    crypto ipsec transform-set 名称 esp/sh-des/3des/aes esp/sh-md5/sha-hmac
    ```
  - 命令分析
    - esp/sh-des/3des/aes 是两组
      - esp/sh是一组，二选一，但是**sh是不进行加密处理，所以可以忽略**
      - des/3des/aes是一组，三选一，选择对称加密的方式
    - esp/sh-md5/sha-hmac 是三组，其中第三组可以写成固定的 hmac
      - esp/sh是一组，二选一
      - md5/sha是一组，二选一，**选择的是数据完整性验证的时候，用到的hash算法**
    - 比如：`crypto ipsec transform-set demo esp-3des esp-md5-hmac`

|

- 2、定义ACL匹配表（定义那些流量可以走VPN，那些流量不能走VPN）
  - ACL可以有多条，会自上而下进行匹配，只要匹配成功，就不会再往下进行匹配，然后执行匹配成功的对应命令（允许还是不允许）
  - 如果都没有匹配成功，则不允许走VPN
  - 具体命令
    ```conf   
    # 100是标记，可以多个VPN复用，但是复用的概率不大（每个VPN的目标网段不一样，就无法复用）
    access-list 100 permit ip 192.168.6.0 0.255.255.255 192.168.8.0 0.255.255.255
    # 前面是当前内网段，后面是对方内网段
    ```
  - 如果只让一台内网IP可以匹配通过，可以如下配置（ACL中的知识）
    - 不写反子网掩码4个255，使用host，简化使用
    - 比如：access-list 100 permit ip host 192.168.6.3  192.168.8.0 0.255.255.255


#### 在端口开启VPN（外网端口）
- **管理连接、数据连接都配置好后，没用。要应用起来配置才有效**
- 指定对方的公网IP和预共享密钥
  - 管理连接的配置，要往对方路由器发送，所以要指定对方的公网IP
  - 预共享密钥用于验证数据完整性和防止被篡改（具体后面介绍）
  - 具体命令
    ```conf
    crypto isakmp key 预共享密钥 address 对方公网IP
    ```

|
- 定义VPN的配置表（map映射表）（**一个表就是一个VPN**）
  - 具体指令
    ```conf
    conf t
    #  mapDemo 表示创建的map映射表的名称
    #  后面跟的 1，是VPN的标识，并不是管理连接配置的 1（管理连接的配置会自动挨个发送，无需指定）
    crypto map mapDemo 1 ipsec-isakmp
      match address 100       # 100，是数据连接中配置的ACL匹配规则的名称
      set transform-set demo  # demo，是数据连接中配置的加密方式的名称
      set peer 对方的公网IP     # 这个会替换目标IP
    exit
    ```
  - 分析
    - **一个端口，只能用一个map映射表（也就是只能指定mapDemo，不能再指定一个mapDemo2）**
    - 一个表只能对应一个VPN，但是，一个端口可以开启多个VPN，这个时候就可以用后面的VPN标识了（也就是mapDemo 后面的1）
    - 具体看后面介绍

|

- 把映射表贴到端口上，准备开启VPN
  - 具体指令
  ```conf
  int f0/0    # f0/0是外网端口（公网插入的端口）
    crypto map mapDemo  # 使用的map对应的名称
  exit 
  ```
  - 分析
    - **把map映射表放在端口上后，并不会立刻开启VPN，而是准备好**
    - 当有一个包需要走VPN的时候，才会开启VPN（发送管理连接的配置，协商密钥，开始加密）


#### 一个端口开启多个VPN的方式
- 1、首先 `crypto isakmp key 预共享密钥 address 对方公网IP` 要重新设置一份
  - 每个局域网的公网IP不同
  - 并且，管理连接配置的所有表，会挨个给每一个 对方公网IP 都发送一份，验证是否匹配（相同才会开启VPN）
- 2、ACL匹配需要重新创建一份
  - 每个局域网的内网段可能不同，也不能相同（相同了两个VPN的ACL就无法区分了，就会走第一个匹配成功VPN通道）
- 3、map映射表要重新创建一份（引用对应的ACL，数据连接配置的数据加密方式可以复用）
  - 要注意，map映射表的名称要统一，ID标记不同相同
  - 比如
    ```conf
    # 这个为 1，叫mapDemo
    crypto map mapDemo 1 ipsec-isakmp
      match address 100      
      set transform-set demo  
      set peer 对方的公网IP
    exit

    # 这个为 2，也叫mapDemo
    crypto map mapDemo 2 ipsec-isakmp
      match address 102  # 对应的ACL
      set transform-set demo  # 数据加密方式可以用同一个
      set peer 对方的公网IP
    exit
    ```
    - 这样，在用 `crypto map mapDemo` 往端口贴VPNmap映射表的时候，会把所有叫 mapDemo 的都贴上去
    - **当包来临的时候，会自上而下，匹配每个ACL，只要成功，就用对应映射表中的 对方的公网IP 替换目标IP**
      - 这样，路由器在路由的时候，就会路由到对方路由器上（即开辟了多个VPN通道）




#### 数据完整性的验证方式
- 把加密完成的数据，用选定的hash算法，生成一个hash值，然后一块发送出去
  - 接收方，接受到数据，把加密的数据，再次放到选定的hash算法，生成一个hash值，然后与传递过来的hash进行比较，如果一样则表示完整，并且没有被篡改
    - 但是这样很容易被第三方篡改，虽然解不开源数据（没有对称加密的密钥），但是可以篡改替换，把一个新值当成加密数据，运行选定的hash算法，重新生成一个hash
    - 然后把新值和新hash传递，接收方用新值，在利用算法，得到的hash一定与传递过来的hash一样
  - **为了避免数据被篡改，就可以使用预共享密钥**
    - 生成hash的时候，把预共享密钥也一块传递进去
    - 接收方，验证的时候，也会把加密数据和自己的预共享密钥传进去，得到的结果与传递过来的hash进行比较
      - 这样一定不会被篡改
      - 如果被篡改，由于第三方不知道预共享密钥，所以生成的hash一定和接收方生成的hash不一样
    - **所以双方配置的预共享密钥要一致才可以**

- 加密和接收解密和验证数据完成行的时候，用到了选定的算法，所以双方才要保持一致
