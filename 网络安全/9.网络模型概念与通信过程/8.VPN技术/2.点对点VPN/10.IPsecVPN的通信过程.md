#### 分类
- IPsecVPN分为两类，一类是传输模式（相对快那么一点），一类是隧道模式（更安全）


#### 两个分类的传输原理
- 传输模式的传输原理（不会加密IP包头）
  - 1、重新生成IP包头
    - 源IP为当前的公网IP，目标IP为VPN通道的结束IP
    - 原来的源IP和目标IP，会放在新IP包头的可选项中，一块发送过去
  - 2、重新生成IP包头后，路由器进行路由，最终会到达VPN终点路由器
  - 3、到达终点路由器后，就会把新的IP包头去掉，重新在生成一个IP包头
    - 源IP和目标IP就是可选项中的原始IP
  - 4、然后在进行路由
    - 此时，目标IP就是原来的目标IP了
    - **如果原始目标IP是内网IP，终点路由是连接外网的路由**
      - 这样，就会路由到内网中，找对应的内网机器
      - 这也是访问一个内网，使用VPN可以成功访问的原因
        - 经过公网IP到达对方路由器，然后根据原始内网IP到达内网机器
        - 由于，从内网访问内网，源IP也是内网，所以回包的时候，也会走VPN（利用公网IP回到路由器，然后在回到内网机器）
  - 5、到达终点路由器后，就会进行解密处理
    
|
- 隧道模式（更安全，会加密原始IP包头）
  - 传输原理，和传输模式的一样
    - 也是重新生成IP包头，利用对方的公网IP，到达对方路由器，然后再利用原始的目标IP，进行路由，到达内网机器
    - 不同点在于：**传输模式把源IP和目标IP放在可选项中，加密IP包头后面的数据，隧道模式先把原始的IP包头以及包头后面的内容进行加密，然后再包上新的IP包头进行传输**
      - 这样，到达终点路由器后，把新的IP包头去掉，然后解密数据
      - 由于，加密的时候，包含原始的IP包头，所以解密后就可以直接使用了，不用再创建一个IP包头了
      - 包上帧头帧尾，就能进行路由到达内网机器了



#### 扩展
- 点对点VPN，必须有一侧的公网IP是固定的
  - 如果有一侧不固定，必须由不固定的先发起VPN，这样固定的另一侧才会知道变化的一侧的公网IP是什么（要先通过VPN往对方发送数据，这样对方接收到包后，就能根据源IP得知公网IP是什么）
    - 固定的不知道变化的IP是什么，所以无法替换数据中的目标IP，也就发不过去
  - 如果两侧都是固定的，则谁先发数据都一样
