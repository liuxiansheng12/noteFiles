
#### 概念
- HSRP协议或者VRRP协议，又被称为热备份路由协议

- 热备份路由是以分组进行划分的：区间范围为：1-255，并且没有大小之分，只是起一个标示作用
- 每一组可以有很多路由，但是通常是两个路由
  - 这两个路由，一个使用，另一个备用。当正在使用的发生故障，另一个备份的路由立即工作，防止引发因为路由损坏而无法上网的问题

- 热备份路由既然起备份路由的作用，所以当正在使用的网关发生问题时，就会自动切换，防止通信断裂
  - 而网关是DHCP上定义好的，也就是网关是一个固定值，无法自动切换
  - 手动又不符合实际，因为不知道网关什么时候坏掉，当得知什么时候坏掉（比如用户反映）更换网关地址，还不如直接更换好的路由
  - 再者说：当得知网关坏掉的时候，此时网络已经断掉，而热备份路由的作用就是防止断网，这样就与热备份路由的作用产生了冲突
  - 要想解决网关不能自动切换的问题：**提出了虚拟网关的概念**，DHCP分配的网关就是虚拟网关
  - 虚拟网关是不会发生变化的，一直是一个固定值，这样就可以放在DHCP上进行使用了

- 这样，如果热备份路由使用的是两个路由，就存在三个路由器IP
  - 一个虚拟路由器（充当网关）
  - 一个活跃路由器（工作的路由器）
  - 一个备份路由器（备用）
  - 如果热备份路由中使用了多个路由（两个以上），其他的路由就被称为了：其他路由器



#### 路由切换的原理（活跃路由器的确定）
- HSRP中的每一个路由器都有一个优先级：优先级最高的那个路由器会被称为活跃路由器
- HSRP组的成员通过定时发送 hello包 来进行交流，以此来确定那个路由器是活跃路由器，那个路由是备份路由器
  - 发送的时间间隔为3秒，坚持时间10秒
- 占先权preempt
  - 作用：当检测不到对方，或者监测到对方优先级比自己低，立刻抢占活跃路由器的名份
  - 路由器通过发送hello包，当检测不到对方，没有收到回包，或者监测到对方优先级比自己低，如果配置了占先权preempt，则立刻成为活跃路由器，如果没有配置，则等一会，大概等10s
  - 通常这个会配置上：如果没有配置，可能会发生一段时间断网（10s后好的路由器才变成活跃路由器）

- 配置跟踪track
  - 作用：跟踪外网端口状态，当外网down掉的时候，表示该路由发生了问题，就会自降自己的优先级
    - 优先级降低，好的路由器通过发送hello包，一看我的比你高，然后就变成活跃路由器（如果配置了占先权preempt，则立刻成为活跃路由器，如果没有配置，则等一会）
  - 一般：最低优先级的路由，不配置这个
    - 该路由已经是最低的了，在降已经没有意义了
    - 因为优先级的降低，就是为了让其他好的路由器的优先级大于该路由器，以此替换活跃路由器
    - 如果这个路由器的优先级已经是最低的了，降不降都没有比他优先级低的路由了（即使有，也是坏的路由，自动降下去的），也就是这是最后一个好的路由了，优先级降下去，也没有替换品了
    - 如果配置了反而不好：
      - 最后一个一降，如果比其他的路由器低
      - 其它路由器，权限高的，就会变成活跃路由器，而此时这个路由一定是之前降下去的，也就是意味着这个路由跟踪的外网端口是坏的
      - 如果变成活跃路由器，一检测，又会自降优先级，然后第二个在降，这样就会陷入一个循环



- 具体的使用原理：后续讲解
- 不是用虚拟路由当网关，用真实的也可以进行通信，利用之前的技术


#### 具体的配置
- 配置
```conf
int f0/0 # 配置那个路由器的接口
  standby 1 ip 192.168.3.244  # 配置使用的虚拟路由器
  standby 1 priority 200      # 配置优先级
  standby 1 preempt           # 配置preempt，立刻抢占
  standby 1 track f0/1 51     # 配置track，监听端口，如果f0/1，自降优先级51 
```
- 查看
  - <img src='https://lsz.net.cn/node/imgs/5457be2d8417c2ec3279b4f1bef9459d.png' />
  - 
  - <img src='https://lsz.net.cn/node/imgs/2964a9ea133fc7971bbffa9a320140ed.png' />


#### 通信原理
- 每个路由器上都有一个表
  - 表内有虚拟路由器，当前路由器是否是活跃路由器

- 当某台设备跨网段通信的时候，会把包发送给路由器
  - 但是，我们用的是虚拟路由器，这台设备是不存在的，交换机不知道，依旧会对ARP进行广播，询问谁是虚拟路由器
  - 此时，两个真正的路由器就会接收到ARP广播
    - 活跃路由器一看，你获取的是虚拟路由器，而虚拟路由器与我对应，并且我是活跃路由器，于是返回自己的mac地址
    - 备份路由器一看，你获取的是虚拟路由器，而虚拟路由器与我对应，但是我是备份路由器，于是不做处理
  - 这样，pc就获取到了mac地址
  - 于是封装帧头帧尾，然后发给交换机
  - 交换机根据目标mac地址，就会把包发给活跃路由器
  - 活跃路由器，一看你的目标mac地址就是我的地址，于是就进行路由处理，到达目标IP，完成通信
- 后续在发送请求，找虚拟路由器，就会走ARP缓存
  - 当活跃路由器挂掉，备份路由器顶上来，就会更改ARP缓存
  - 如果删掉，在走上面的流程，如果发送ARP应答包，则替换ARP，直接往新的活跃路由器发送
