# React中的事件机制

1. React中对事件的处理真实的过程
    1) React中对事件的绑定，是进行了优化的，采用了更高效的方式。
    React会先在document上绑定所有可以进行冒泡的事件。
    
    2) 开发者在React元素上通过on绑定的事件，比如onClick，其实并没有在真实的dom上绑定事件。
    
    3) React使用的方式是，点击该真实的dom，事件就会进行冒泡，最终冒泡到document上。
       触发React在document上绑定的点击事件，然后分析触发的事件源。
       随后查询React虚拟dom树，从React元素树中找到对应的React元素，直接执行注册的点击函数。
       然后顺着React虚拟dom树，向上查询，只要有父元素使用了onClick注册事件，就会执行注册函数。产生冒泡的现象。

2. 分析改变真实dom的位置，但是冒泡却依旧按照React虚拟dom树的结构进行冒泡的原因

    1) 某个元素绑定了事件，但是该元素通过createPortal改变了真实dom的插入位置。
    2) 当点击该元素的时候，其实是正常按照真实dom树的结构进行冒泡，直到document。
    3) 然后React手动调动对应的事件，然后从事件源的位置，顺着React元素树进行查询。
    4) createPortal虽然改变了真实dom的位置，但是在React元素树中的位置并没有发生变化。所以产生了该现象。
    如果React元素的位置也变到指定的位置，则React查询的方向和真实dom冒泡的方向就会相同。
    5) 所以这种现象都是假象，是React搞的鬼。


3. React中的事件对象event
    1) event的原理
    其实React中的事件对象event，也不是原始的事件对象event。
    原始的事件对象是document的事件对象，要来没什么用，所以React就舍弃了真实的event。
    自己创造了一个event，传入的就是React自己高度合成的event。

    2) event的优化
    并且React为了节约效率，先把event对象创建好了，平时的时候内部的每个属性都为null。
    当需要的时候生成对应的event对象，然后传入对应的事件中，当事件函数执行完，event对象中的属性就会进行初始化，为冒泡或者下一次事件的触发做赋值准备。


4. 根据React绑定事件的方式和event优化的原理，产生了一些现象

    1) 父元素事件先触发，子元素事件在触发，不符合冒泡原理。
       该现象产生的必要条件:
       父元素是通过dom，直接绑定的事件而不是通过React语法绑定的事件。
       子元素的事件是通过React语法进行绑定的事件。
       现象分析:
       通过React语法绑定事件，并不会真正的绑定到该dom上。触发时，进行进行冒泡。
       如果在真实dom冒泡的过程中，在某个父dom上直接绑定了事件，则先触发该事件。
       然后在继续冒泡，直到到达document，触发React绑定的点击事件。
       然后在反过来执行对应的事件函数。
       造成了表象上父组件的事件先执行，子组件的事件在执行的现象。
    
    2) 真实dom上绑定的事件，阻止事件冒泡，React绑定的事件就会失效。
       在冒泡过程中的某个真实dom绑定的事件上阻止了事件冒泡，则document上的事件无法执行，无法进行分析自动调动对应的方法，产生事件失效的现象。

    3) 事件函数中异步使用event，需要进行特殊的处理 
       由于React对event进行了优化，事件执行完，event就会初始化，为下次的传入做准备。
       如果异步使用event，使用的是初始化的even。
       不会获取到自己的event，和其它事件的event，只有当任务队列空时，异步函数才会执行，此时事件函数以及处理完毕，event已经进行了初始化。
       所以异步直接使用event会出现大问题。
       解决方式: 
       在事件中调用e.persist()，进行事件对象的固化。
       原理可以看成，把e克隆一份，然后在赋给e。React在操作React中创建的事件对象event时，就与该事件中的e没有关系了。

    4) stopPropagation阻止冒泡的原理
       stopPropagation阻止的是沿React元素树查询的过程，当查询到该位置，阻止查询，则上方的事件函数不在执行，造成阻止事件的表象，其实并没有组织真实dom的冒泡。


